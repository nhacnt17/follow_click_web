<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ghi nháº­n truy cáº­p áº©n danh</title>
</head>
<body>
  <h1>ğŸ”¥ ChÃ o báº¡n Ä‘áº¿n vá»›i FollowClickWeb</h1>
  <p>LÆ°á»£t truy cáº­p cá»§a báº¡n Ä‘ang Ä‘Æ°á»£c ghi nháº­n vÃ o Firebase...</p>
  <p id="status">Äang xá»­ lÃ½...</p>

  <script type="module">
    import { db, doc, setDoc, getDoc } from './firebase.js';

    // HÃ m láº¥y hoáº·c táº¡o cookie
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    function setCookie(name, value, days) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = `${name}=${value}; expires=${expires}; path=/; SameSite=None; Secure`;
    }

    async function saveVisit(visitorId, visitTime, userAgent, screenSize, storageMethod, timeSpent) {
      const newVisit = {
        visitTime,
        userAgent,
        screenSize,
        storageMethod,
        timeSpent: timeSpent || 0.1
      };

      console.log("ğŸ“‹ Dá»¯ liá»‡u lÆ°á»£t truy cáº­p:", newVisit);

      try {
        const visitorRef = doc(db, "userclickprofile", visitorId);
        const visitorSnap = await Promise.race([
          getDoc(visitorRef),
          new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout waiting for getDoc")), 10000))
        ]);

        if (visitorSnap.exists()) {
          const visitorData = visitorSnap.data();
          const updatedVisits = [...visitorData.visits, newVisit];
          await Promise.race([
            setDoc(visitorRef, { ...visitorData, visits: updatedVisits }, { merge: true }),
            new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout waiting for setDoc")), 10000))
          ]);
          console.log(`âœ… Cáº­p nháº­t lÆ°á»£t truy cáº­p cho visitorId: ${visitorId}`);
        } else {
          await Promise.race([
            setDoc(visitorRef, { visitorId, visits: [newVisit] }),
            new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout waiting for setDoc")), 10000))
          ]);
          console.log(`âœ… Táº¡o má»›i document cho visitorId: ${visitorId}`);
        }
      } catch (e) {
        console.error("âŒ Lá»—i khi ghi nháº­n truy cáº­p:", e.message);
        document.getElementById("status").innerText = `âŒ Lá»—i: ${e.message}`;
      }
    }

    async function trackVisit() {
      let visitorId;
      let storageMethod = "localStorage";
      let timeSpent = 0;
      let interval = null;

      // Thá»­ sá»­ dá»¥ng localStorage trÆ°á»›c
      try {
        localStorage.setItem("test", "test");
        localStorage.removeItem("test");
        console.log("âœ… localStorage hoáº¡t Ä‘á»™ng");

        if (!localStorage.getItem('visitor_id')) {
          localStorage.setItem('visitor_id', crypto.randomUUID());
        }
        visitorId = localStorage.getItem('visitor_id');
      } catch (e) {
        console.warn("âš ï¸ localStorage bá»‹ cháº·n, chuyá»ƒn sang dÃ¹ng cookie:", e.message);
        storageMethod = "cookie";

        visitorId = getCookie('visitor_id');
        if (!visitorId) {
          visitorId = crypto.randomUUID();
          setCookie('visitor_id', visitorId, 365);
        }
      }

      const visitTime = new Date().toISOString();
      const userAgent = navigator.userAgent;
      const screenSize = `${window.screen.width}x${window.screen.height}`;

      // Báº¯t Ä‘áº§u Ä‘áº¿m timeSpent sau khi DOM sáºµn sÃ ng
      document.addEventListener('DOMContentLoaded', () => {
        const startTime = Date.now();
        console.log("âœ… DOM sáºµn sÃ ng, báº¯t Ä‘áº§u Ä‘áº¿m timeSpent");

        // Cáº­p nháº­t timeSpent má»—i giÃ¢y
        interval = setInterval(() => {
          timeSpent = (Date.now() - startTime) / 1000;
          console.log(`â± Thá»i gian truy cáº­p: ${timeSpent} giÃ¢y`);
        }, 1000);

        // Ghi Firestore Ä‘á»‹nh ká»³ (má»—i 5 giÃ¢y)
        setInterval(() => {
          if (timeSpent > 0) {
            saveVisit(visitorId, visitTime, userAgent, screenSize, storageMethod, timeSpent);
          }
        }, 5000);
      });

      // Dá»«ng Ä‘áº¿m vÃ  ghi khi trang áº©n
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden' && interval) {
          clearInterval(interval);
          console.log(`â¹ Dá»«ng Ä‘áº¿m: ${timeSpent} giÃ¢y`);
          saveVisit(visitorId, visitTime, userAgent, screenSize, storageMethod, timeSpent);
        }
      });

      // Ghi Firestore khi rá»i trang
      window.addEventListener('beforeunload', () => {
        if (interval) {
          clearInterval(interval);
          console.log(`â¹ Dá»«ng Ä‘áº¿m vÃ  ghi Firestore: ${timeSpent} giÃ¢y`);
          saveVisit(visitorId, visitTime, userAgent, screenSize, storageMethod, timeSpent);
        }
      });

      // Hiá»ƒn thá»‹ tráº¡ng thÃ¡i máº·c Ä‘á»‹nh
      document.getElementById("status").innerText = `âœ… Äang theo dÃµi lÆ°á»£t truy cáº­p...`;
    }

    trackVisit();
  </script>
</body>
</html>