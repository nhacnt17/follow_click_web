<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ghi nháº­n truy cáº­p áº©n danh</title>
</head>
<body>
  <h1>ğŸ”¥ ChÃ o báº¡n Ä‘áº¿n vá»›i FollowClickWeb</h1>
  <p>LÆ°á»£t truy cáº­p cá»§a báº¡n Ä‘ang Ä‘Æ°á»£c ghi nháº­n vÃ o Firebase...</p>
  <p id="status">Äang xá»­ lÃ½...</p>

  <script type="module">
    import { db, doc, setDoc, getDoc } from './firebase.js';

    async function trackVisit() {
      // Táº¡o visitor ID áº©n danh náº¿u chÆ°a cÃ³
      if (!localStorage.getItem('visitor_id')) {
        localStorage.setItem('visitor_id', crypto.randomUUID());
      }

      const visitorId = localStorage.getItem('visitor_id');
      const visitTime = new Date().toISOString();
      const userAgent = navigator.userAgent;
      const screenSize = `${window.screen.width}x${window.screen.height}`;

      // Dá»¯ liá»‡u lÆ°á»£t truy cáº­p má»›i
      const newVisit = {
        visitTime,
        userAgent,
        screenSize
      };

      // Log dá»¯ liá»‡u truy cáº­p má»›i
      console.log("ğŸ“‹ Dá»¯ liá»‡u lÆ°á»£t truy cáº­p má»›i:", newVisit);

      try {
        // Tham chiáº¿u Ä‘áº¿n document trong collection userclickprofile
        const visitorRef = doc(db, "userclickprofile", visitorId);

        // Kiá»ƒm tra xem visitorId Ä‘Ã£ tá»“n táº¡i chÆ°a
        const visitorSnap = await Promise.race([
          getDoc(visitorRef),
          new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout waiting for getDoc")), 10000))
        ]);

        if (visitorSnap.exists()) {
          // Náº¿u Ä‘Ã£ tá»“n táº¡i, láº¥y dá»¯ liá»‡u hiá»‡n táº¡i vÃ  thÃªm lÆ°á»£t truy cáº­p má»›i vÃ o máº£ng visits
          const visitorData = visitorSnap.data();
          const updatedVisits = [...visitorData.visits, newVisit];

          // Cáº­p nháº­t document vá»›i máº£ng visits má»›i
          await Promise.race([
            setDoc(visitorRef, { ...visitorData, visits: updatedVisits }, { merge: true }),
            new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout waiting for setDoc")), 10000))
          ]);

          console.log(`âœ… Cáº­p nháº­t lÆ°á»£t truy cáº­p cho visitorId: ${visitorId}`);
          document.getElementById("status").innerText = `âœ… ÄÃ£ cáº­p nháº­t lÆ°á»£t truy cáº­p cho visitorId: ${visitorId}`;
        } else {
          // Náº¿u chÆ°a tá»“n táº¡i, táº¡o document má»›i vá»›i máº£ng visits chá»©a lÆ°á»£t truy cáº­p Ä‘áº§u tiÃªn
          await Promise.race([
            setDoc(visitorRef, { visitorId, visits: [newVisit] }),
            new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout waiting for setDoc")), 10000))
          ]);

          console.log(`âœ… Táº¡o má»›i document cho visitorId: ${visitorId}`);
          document.getElementById("status").innerText = `âœ… ÄÃ£ táº¡o má»›i document cho visitorId: ${visitorId}`;
        }
      } catch (e) {
        console.error("âŒ Lá»—i khi ghi nháº­n truy cáº­p:", e.message);
        document.getElementById("status").innerText = `âŒ Lá»—i: ${e.message}`;
      }
    }

    trackVisit();
  </script>
</body>
</html>