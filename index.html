<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ghi nh·∫≠n truy c·∫≠p ·∫©n danh</title>
</head>
<body>
  <h1>üî• Ch√†o b·∫°n ƒë·∫øn v·ªõi FollowClickWeb</h1>
  <p>L∆∞·ª£t truy c·∫≠p c·ªßa b·∫°n ƒëang ƒë∆∞·ª£c ghi nh·∫≠n v√†o Firebase...</p>
  <p id="status">ƒêang x·ª≠ l√Ω...</p>

  <script type="module">
    import { db, doc, setDoc, getDoc, collection } from './firebase.js';

    // T·∫°o visitor ID ·∫©n danh n·∫øu ch∆∞a c√≥
    if (!localStorage.getItem('visitor_id')) {
      localStorage.setItem('visitor_id', crypto.randomUUID());
    }

    const visitorId = localStorage.getItem('visitor_id');
    const visitTime = new Date().toISOString();
    const userAgent = navigator.userAgent;
    const screenSize = `${window.screen.width}x${window.screen.height}`;

    // D·ªØ li·ªáu l∆∞·ª£t truy c·∫≠p m·ªõi
    const newVisit = {
      visitTime,
      userAgent,
      screenSize
    };

    // Log d·ªØ li·ªáu truy c·∫≠p m·ªõi
    console.log("üìã D·ªØ li·ªáu l∆∞·ª£t truy c·∫≠p m·ªõi:", newVisit);

    try {
      // Tham chi·∫øu ƒë·∫øn document trong collection followclick/visitors
      const visitorRef = doc(db, "userclickprofile", visitorId);

      // Ki·ªÉm tra xem visitorId ƒë√£ t·ªìn t·∫°i ch∆∞a
      const visitorSnap = await getDoc(visitorRef);

      if (visitorSnap.exists()) {
        // N·∫øu ƒë√£ t·ªìn t·∫°i, l·∫•y d·ªØ li·ªáu hi·ªán t·∫°i v√† th√™m l∆∞·ª£t truy c·∫≠p m·ªõi v√†o m·∫£ng visits
        const visitorData = visitorSnap.data();
        const updatedVisits = [...visitorData.visits, newVisit];

        // C·∫≠p nh·∫≠t document v·ªõi m·∫£ng visits m·ªõi
        await setDoc(visitorRef, {
          ...visitorData,
          visits: updatedVisits
        }, { merge: true });

        console.log(`‚úÖ C·∫≠p nh·∫≠t l∆∞·ª£t truy c·∫≠p cho visitorId: ${visitorId}`);
        document.getElementById("status").innerText = `‚úÖ ƒê√£ c·∫≠p nh·∫≠t l∆∞·ª£t truy c·∫≠p cho visitorId: ${visitorId}`;
      } else {
        // N·∫øu ch∆∞a t·ªìn t·∫°i, t·∫°o document m·ªõi v·ªõi m·∫£ng visits ch·ª©a l∆∞·ª£t truy c·∫≠p ƒë·∫ßu ti√™n
        await setDoc(visitorRef, {
          visitorId,
          visits: [newVisit]
        });

        console.log(`‚úÖ T·∫°o m·ªõi document cho visitorId: ${visitorId}`);
        document.getElementById("status").innerText = `‚úÖ ƒê√£ t·∫°o m·ªõi document cho visitorId: ${visitorId}`;
      }
    } catch (e) {
      console.error("‚ùå L·ªói khi ghi nh·∫≠n truy c·∫≠p:", e.message);
      document.getElementById("status").innerText = `‚ùå L·ªói: ${e.message}`;
    }
  </script>
</body>
</html>